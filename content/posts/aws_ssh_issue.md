+++
date = '2024-11-27T00:18:34+09:00'
draft = false
title = 'AWSでSSH接続できない問題を解決した話'
+++

## はじめに
先日、AWSで立てたEC2インスタンスにSSH接続できなくなる問題が発生しました。このトラブルの原因と解 決方法を記録しておきます。同じ状況に陥った方の助けになれば幸いです。

---

## 問題の症状
- EC2インスタンスにSSH接続を試みると、`Connection timed out` のエラーが表示される。
- AWSコンソール上では、インスタンスは正常に動作中。
- ブラウザからの接続は可能（インスタンス内のApacheは稼働中）。

---

## 原因と解決方法
調査の結果、以下の4つの原因が考えられました。

### **原因1: セキュリティグループのルール設定ミス**
**問題点**
セキュリティグループでポート22（SSH）が許可されていなかった。

**解決方法**
AWSコンソールのセキュリティグループ設定に以下のルールを追加：
- タイプ: SSH
- プロトコル: TCP
- ポート範囲: 22
- ソース: 自分のグローバルIPアドレス（例: `203.0.113.0/32`）

---

### **原因2: UFW（Uncomplicated Firewall）がポート22を閉じていた**
**問題点**
EC2インスタンス内のUFW（ローカルファイアウォール）でポート22が閉じられていた。

**解決方法**
以下のコマンドを実行してポート22を許可し、設定を反映しました。

```bash
sudo ufw allow 22
sudo ufw reload
```

---

### **原因3: グローバルIPの変動**
**問題点**
自分のグローバルIPアドレスが変更されたことで、セキュリティグループのルールが機能しなくなった。

**解決方法**
新しいグローバルIPを確認し、セキュリティグループのSSHルールを更新しました。

```bash
curl ifconfig.me
```

---

### **原因4: インターネットゲートウェイの設定ミス**
**問題点**
インターネットゲートウェイがVPCに正しくアタッチされていなかった。

**解決方法**
AWSコンソールのVPCダッシュボードで以下を確認しました：
1. インターネットゲートウェイがVPCにアタッチされていること。
2. ルートテーブルに`0.0.0.0/0`のデフォルトルートがインターネットゲートウェイを指していること。

```bash
# 例: ルートテーブルの確認コマンド
aws ec2 describe-route-tables --query "RouteTables[*].Routes"
```

---

## 解決のポイント
このケースでは、**UFWの設定でポート22が閉じていた** ことが主な原因でした。ローカルのファイアウォール設定とAWSのセキュリティグループ設定が一致していないことが問題を引き起こしていました。

---

## 学んだこと
今回のトラブルから、以下の教訓を得ました：

1. **複数のセキュリティ設定を確認する**
   - AWSのセキュリティグループ設定だけでなく、サーバー内のファイアウォール設定（UFWやiptables） も忘れずに確認する。

2. **接続トラブルの調査フローを明確にする**
   以下の順番で確認するとスムーズに解決できます：
   1. セキュリティグループの設定確認。
   2. ローカルファイアウォールの設定確認。
   3. インターネットゲートウェイとルートテーブルの設定確認。
   4. ローカルマシンのグローバルIPアドレス確認。

---

## おわりに
「接続できない」という問題はシンプルに見えて、原因が複数絡んでいる場合があります。トラブルシューティングは焦らず、落ち着いて一つずつ原因を切り分けていくことが重要です。

今回の記録が、同じ状況に陥った方の参考になれば幸いです。

